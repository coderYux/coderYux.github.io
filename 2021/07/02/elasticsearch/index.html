<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="elasticsearch," />










<meta name="description" content="1. 集群和分布式集群和分布式的概念有联系也有区别，我们一起来看。 1.1 单点式服务的问题如图所示，是我们之前项目使用的架构方式，单点服务架构。整个服务使一个完整的项目，部署在一台tomcat，使用一个mysql数据库：  所有的请求，都由这一台服务器处理，存在很大风险： A：并发处理能力有限。因为单服务器的性能有限制。所以单台Tomcat的最大连接数有限制，   B：容错率低，一旦服务器故障，">
<meta property="og:type" content="article">
<meta property="og:title" content="elasticsearch">
<meta property="og:url" content="http://example.com/2021/07/02/elasticsearch/index.html">
<meta property="og:site_name" content="Yux&#39;s Notes">
<meta property="og:description" content="1. 集群和分布式集群和分布式的概念有联系也有区别，我们一起来看。 1.1 单点式服务的问题如图所示，是我们之前项目使用的架构方式，单点服务架构。整个服务使一个完整的项目，部署在一台tomcat，使用一个mysql数据库：  所有的请求，都由这一台服务器处理，存在很大风险： A：并发处理能力有限。因为单服务器的性能有限制。所以单台Tomcat的最大连接数有限制，   B：容错率低，一旦服务器故障，">
<meta property="og:locale">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1543286552773.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1543286678122.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1543287433625.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1543287806342.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1543288401040.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1543288684507.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1543288817235.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1543289444226.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1553071443011.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1553072275126.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1575467048005.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1575467083227.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1575467250968.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1575467279027.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1588141227308.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1575467330712.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1596177415223.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1553651744294.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1553651841987.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1553657415587.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1553652153727.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1554383466912.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1596177823927.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1553654415047.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1553658784911.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1554348626154.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1554348779338.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1553664109185.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1554280774790.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1554349744329.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1554349849946.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1554356961547.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1554357142660.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1526539628841.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1526539880872.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1526540053252.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1584854172805.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1554378139181.png">
<meta property="og:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1554378494161.png">
<meta property="article:published_time" content="2021-07-02T08:02:04.000Z">
<meta property="article:modified_time" content="2021-07-05T03:45:24.952Z">
<meta property="article:author" content="樊宇璇">
<meta property="article:tag" content="elasticsearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="e:/java/javaee/4-Spring/day12-elasticsearch/讲义/assets/1543286552773.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/2021/07/02/elasticsearch/"/>





  <title>elasticsearch | Yux's Notes</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
		<a target="_blank" rel="noopener" href="https://github.com/coderYux" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
	
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Yux's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">副标题</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/02/elasticsearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yux's Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">elasticsearch</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-02T16:02:04+08:00">
                2021-07-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1-集群和分布式"><a href="#1-集群和分布式" class="headerlink" title="1. 集群和分布式"></a>1. 集群和分布式</h1><p>集群和分布式的概念有联系也有区别，我们一起来看。</p>
<h2 id="1-1-单点式服务的问题"><a href="#1-1-单点式服务的问题" class="headerlink" title="1.1 单点式服务的问题"></a>1.1 单点式服务的问题</h2><p>如图所示，是我们之前项目使用的架构方式，单点服务架构。整个服务使一个完整的项目，部署在一台tomcat，使用一个mysql数据库：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1543286552773.png" alt="1543286552773"></p>
<p>所有的请求，都由这一台服务器处理，存在很大风险：</p>
<pre><code>A：并发处理能力有限。因为单服务器的性能有限制。所以单台Tomcat的最大连接数有限制， 

B：容错率低，一旦服务器故障，整个服务就无法访问了。

    eBay于 1999年6月停机22小时的事故，中断了约230万的拍卖，使eBay的股票下降了9.2个百分点。

C：单台服务器计算能力低，无法完成复杂的海量数据计算。
</code></pre>
<p>如何解决这样的问题呢？那就需要使用计算机集群了。</p>
<span id="more"></span>

<h2 id="1-2-集群"><a href="#1-2-集群" class="headerlink" title="1.2 集群"></a>1.2 集群</h2><p>来看下维基百科对集群的介绍：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1543286678122.png" alt="1543286678122"></p>
<p>集群是==一组计算机==高度紧密协作，完成计算工作。其中的每个计算机称为一个==节点==。根据这些计算机的协作方式不同或者目的不同，我们将集群分成三类：</p>
<ul>
<li>高可用集群</li>
<li>负载均衡集群</li>
<li>科学计算集群（分布式处理）</li>
</ul>
<p>上述几种集群方式并非必须独立使用，我们在系统架构时经常会组合使用。</p>
<h3 id="1-2-1-高可用集群"><a href="#1-2-1-高可用集群" class="headerlink" title="1.2.1 高可用集群"></a>1.2.1 高可用集群</h3><p>High availability Cluster高可用群集，简称HAC。其设计思想是为了避免出现单点故障问题，在故障时可以==快速恢复，快速继续提供服务==。</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1543287433625.png" alt="1543287433625"></p>
<p>如图所示，集群中两台计算机node01和node02，两者共享资源，处理业务也基本一致，互为==主从==。当node01工作时，node02就处于待命状态。所有业务在Node01上运行，若发生故障服务和资源会转移到Node02上。</p>
<p>这种架构保证了服务的高可用，但是闲置的节点是对资源的一种浪费。</p>
<h3 id="1-2-2-负载均衡集群"><a href="#1-2-2-负载均衡集群" class="headerlink" title="1.2.2 负载均衡集群"></a>1.2.2 负载均衡集群</h3><p>Load Balancing负载均衡，集群中的每一台计算机都来完成相同业务，不分主次。当用户请求到达时，通过某种算法，让请求均衡的分发到集群中的每个节点，充分利用每个节点的资源。如图所示：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1543287806342.png" alt="1543287806342"></p>
<p>因为每个节点业务相同，如果某个节点出现故障，只需要把请求分发到其它节点即可。</p>
<h3 id="1-2-3-科学计算集群"><a href="#1-2-3-科学计算集群" class="headerlink" title="1.2.3 科学计算集群"></a>1.2.3 科学计算集群</h3><p>因为硬件设备的限制，单台计算机的处理性能是有上限的，如果计算需要的资源超过了单台计算机的能力，该怎么办呢？此时就可以使用科学计算集群。</p>
<p>我们把复杂任务拆分成一个个小的子任务，然后分配到集群中的不同节点上完成，最后再把计算结果汇总。这样大量低廉的PC机互联起来，组成一个”超级计算机”以解决复杂的计算任务。</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1543288401040.png" alt="1543288401040"></p>
<p>这样的方式也称为==<strong>分布式运算或者分布式集群</strong>==，集群中的每个节点完成==<strong>不同任务</strong>==。</p>
<h2 id="1-3-分布式web应用"><a href="#1-3-分布式web应用" class="headerlink" title="1.3 分布式web应用"></a>1.3 分布式web应用</h2><p>上述计算机协作的集群方式任何领域都可以使用，在web开发中也是如此，不过有一些细节的不同。我们以一个电商网站为例，看看几种架构方式：</p>
<h3 id="1-3-1-单体应用"><a href="#1-3-1-单体应用" class="headerlink" title="1.3.1 单体应用"></a>1.3.1 单体应用</h3><p>所有业务在一个系统中完成：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1543288684507.png" alt="1543288684507"></p>
<p>出现的问题：</p>
<ul>
<li>系统庞大，功能耦合，难以维护</li>
<li>并发能力差，容易出现单点故障</li>
<li>无法针对不同功能进行优化</li>
</ul>
<h3 id="1-3-2-分布式架构"><a href="#1-3-2-分布式架构" class="headerlink" title="1.3.2 分布式架构"></a>1.3.2 分布式架构</h3><p>按照上面的分布式集群概念，集群中的每个节点完成不同业务。在web开发中也是如此，我们把完整系统进行拆分，形成独立系统，然后部署到不同的tomcat节点，不同节点通过网络通信，相互协作。</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1543288817235.png" alt="1543288817235"></p>
<p>这样就将复杂系统细分，但是却带来了另一个问题，就是单个节点故障会导致整个系统不完整。</p>
<h3 id="1-3-3-高可用分布式集群架构"><a href="#1-3-3-高可用分布式集群架构" class="headerlink" title="1.3.3 高可用分布式集群架构"></a>1.3.3 高可用分布式集群架构</h3><p>为了解决上面所述的单点故障问题，我们可以为分布式系统中的每个节点都部署负载均衡节点，即：每个业务系统都有一个负载均衡的小集群。</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1543289444226.png" alt="1543289444226"></p>
<h1 id="2-Elasticsearch集群"><a href="#2-Elasticsearch集群" class="headerlink" title="2.Elasticsearch集群"></a>2.Elasticsearch集群</h1><p>在之前的课程中，我们都是使用单点的elasticsearch，接下来我们会学习如何搭建Elasticsearch的集群。</p>
<h2 id="2-1-单点的问题"><a href="#2-1-单点的问题" class="headerlink" title="2.1.单点的问题"></a>2.1.单点的问题</h2><p>单点的elasticsearch存在哪些可能出现的问题呢？</p>
<ul>
<li>单台机器存储容量有限</li>
<li>单服务器容易出现单点故障，无法实现高可用</li>
<li>单服务的并发处理能力有限</li>
</ul>
<p>所以，为了应对这些问题，我们需要对elasticsearch搭建集群</p>
<h2 id="2-2-集群的结构"><a href="#2-2-集群的结构" class="headerlink" title="2.2.集群的结构"></a>2.2.集群的结构</h2><p>那么，到底该如何搭建集群呢？</p>
<h3 id="2-2-1-数据分片"><a href="#2-2-1-数据分片" class="headerlink" title="2.2.1.数据分片"></a>2.2.1.数据分片</h3><p>首先，我们面临的第一个问题就是数据量太大，单点存储量有限的问题。</p>
<p>大家觉得应该如何解决？</p>
<p>没错，我们可以把数据拆分成多份，每一份存储到不同机器节点（node），从而实现减少每个节点数据量的目的。这就是数据的分布式存储，也叫做：<code>数据分片（Shard）</code>。</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1553071443011.png" alt="1553071443011"></p>
<h3 id="2-2-2-数据备份"><a href="#2-2-2-数据备份" class="headerlink" title="2.2.2.数据备份"></a>2.2.2.数据备份</h3><p>数据分片解决了海量数据存储的问题，但是如果出现单点故障，那么分片数据就不再完整，这又该如何解决呢？</p>
<p>没错，就像大家为了备份手机数据，会额外存储一份到移动硬盘一样。我们可以给每个分片数据进行备份，存储到其它节点，防止数据丢失，这就是数据备份，也叫<code>数据副本（replica）</code>。</p>
<p>数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高了！</p>
<p>为了在高可用和成本间寻求平衡，我们可以这样做：</p>
<ul>
<li>首先对数据分片，存储到不同节点</li>
<li>然后对每个分片进行备份，放到对方节点，完成互相备份</li>
</ul>
<p>这样可以大大减少所需要的服务节点数量，如图，我们以3分片，每个分片备份一份为例：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1553072275126.png" alt="1553072275126"></p>
<p>在这个集群中，如果出现单节点故障，并不会导致数据缺失，所以保证了集群的高可用，同时也减少了节点中数据存储量。并且因为是多个节点存储数据，因此用户请求也会分发到不同服务器，并发能力也得到了一定的提升。</p>
<h2 id="2-3-搭建集群"><a href="#2-3-搭建集群" class="headerlink" title="2.3.搭建集群"></a>2.3.搭建集群</h2><p>集群需要多台机器，我们这里用一台机器来模拟，因此我们需要在一台虚拟机中部署多个elasticsearch节点，每个elasticsearch的端口都必须不一样。</p>
<p>我们计划集群名称为：leyou-elastic，部署3个elasticsearch节点，分别是：</p>
<p>node-01：http端口9201，TCP端口9301</p>
<p>node-02：http端口9202，TCP端口9302</p>
<p>node-03：http端口9203，TCP端口9303</p>
<p>先把目前电脑上的es和kibana关闭</p>
<p>第一步：把昨天安装的ES软件中复制一份，把复制出来软件中的data文件夹的数据删除（<strong>一定要做</strong>）</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1575467048005.png" alt="1575467048005"></p>
<p>第二步：复制es软件粘贴3次，分别改名</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1575467083227.png" alt="1575467083227"></p>
<p>第三步：修改每一个节点的配置文件 config下的elasticsearch.yml,下面已第一份配置文件为例</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#允许跨域名访问</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="comment"># 集群的名称</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">leyou-elastic</span></span><br><span class="line"><span class="comment">#当前节点名称 每个节点不一样</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">node-01</span></span><br><span class="line"><span class="comment">#数据的存放路径 每个节点不一样</span></span><br><span class="line"><span class="attr">path.data:</span> <span class="string">d:\class\sorfware\elasticsearch-9201\data</span></span><br><span class="line"><span class="comment">#日志的存放路径 每个节点不一样</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">d:\class\sorfware\elasticsearch-9201\logs</span></span><br><span class="line"><span class="comment"># http协议的对外端口 每个节点不一样</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9201</span></span><br><span class="line"><span class="comment"># TCP协议对外端口 每个节点不一样</span></span><br><span class="line"><span class="attr">transport.tcp.port:</span> <span class="number">9301</span></span><br><span class="line"><span class="comment">#三个节点相互发现</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> [<span class="string">&quot;127.0.0.1:9301&quot;</span>,<span class="string">&quot;127.0.0.1:9302&quot;</span>,<span class="string">&quot;127.0.0.1:9303&quot;</span>]</span><br><span class="line"><span class="comment">#声明大于几个的投票主节点有效，请设置为（nodes / 2） + 1</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">2</span></span><br><span class="line"><span class="comment"># 是否为主节点</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>按照上面的内容修改其他两个配置文件，注意：保存时一定确保文件的保存编码是utf-8</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1575467250968.png" alt="1575467250968"></p>
<p>第四步：启动集群</p>
<p>把三个节点分别启动,启动时不要着急，要一个一个地启动</p>
<p>使用head插件查看</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1575467279027.png" alt="1575467279027"></p>
<h2 id="2-4-测试集群中创建索引库"><a href="#2-4-测试集群中创建索引库" class="headerlink" title="2.4.测试集群中创建索引库"></a>2.4.测试集群中创建索引库</h2><p>配置kibana，再重启</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1588141227308.png" alt="1588141227308"></p>
<p>搭建集群以后就要创建索引库了，那么问题来了，当我们创建一个索引库后，数据会保存到哪个服务节点上呢？如果我们对索引库分片，那么每个片会在哪个节点呢？</p>
<p>这个要亲自尝试才知道。</p>
<p>还记得创建索引库的API吗？</p>
<ul>
<li><p>请求方式：PUT</p>
</li>
<li><p>请求路径：/索引库名</p>
</li>
<li><p>请求参数：json格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;属性名&quot;</span>: <span class="string">&quot;属性值&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>settings：就是索引库设置，其中可以定义索引库的各种属性，目前我们可以不设置，都走默认。</p>
</li>
</ul>
<p>这里给搭建看看集群中分片和备份的设置方式，示例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /heima</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有两个配置：</p>
<ul>
<li>number_of_shards：分片数量，这里设置为3</li>
<li>number_of_replicas：副本数量，这里设置为1，每个分片一个备份，一个原始数据，共2份。</li>
</ul>
<p>通过chrome浏览器的head查看，我们可以查看到分片的存储结构：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1575467330712.png" alt="1575467330712"></p>
<p>可以看到，heima这个索引库，有三个分片，分别是0、1、2，每个分片有1个副本，共6份。</p>
<ul>
<li>node-01上保存了0号分片和1号分片的副本</li>
<li>node-02上保存了1号分片和2号分片的副本</li>
<li>node-03上保存了0号分片和2号分片的副本</li>
</ul>
<h1 id="3-Elasticsearch客户端"><a href="#3-Elasticsearch客户端" class="headerlink" title="3.Elasticsearch客户端"></a>3.Elasticsearch客户端</h1><h2 id="3-1-客户端介绍"><a href="#3-1-客户端介绍" class="headerlink" title="3.1.客户端介绍"></a>3.1.客户端介绍</h2><p>在elasticsearch官网中提供了各种语言的客户端：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a></p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1596177415223.png" alt="1596177415223"></p>
<p>我们接下来要学习的是JavaRestClient的客户端。</p>
<p>注意点击进入后，选择版本到<code>6.2</code>，因为我们之前按照的都是<code>6.2.4</code>版本：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1553651744294.png" alt="1553651744294"></p>
<p>然后选择<code>Java High Level Rest Client</code>版本：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1553651841987.png" alt="1553651841987"></p>
<h2 id="3-2-创建Demo工程"><a href="#3-2-创建Demo工程" class="headerlink" title="3.2.创建Demo工程"></a>3.2.创建Demo工程</h2><h3 id="3-2-1-初始化项目"><a href="#3-2-1-初始化项目" class="headerlink" title="3.2.1.初始化项目"></a>3.2.1.初始化项目</h3><p>选择用maven创建：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1553657415587.png" alt="1553657415587"></p>
<p>选择目录：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1553652153727.png" alt="1553652153727"></p>
<h3 id="3-2-2-pom文件"><a href="#3-2-2-pom文件" class="headerlink" title="3.2.2.pom文件"></a>3.2.2.pom文件</h3><p>注意，这里我们直接导入了SpringBoot的启动器，方便后续讲解。不过还需要手动引入elasticsearch的High-level-Rest-Client的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>es-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-3-配置文件"><a href="#3-2-3-配置文件" class="headerlink" title="3.2.3.配置文件"></a>3.2.3.配置文件</h3><p>我们在resource下引入application.yml： 先空着，明天用</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1554383466912.png" alt="1554383466912"> </p>
<h2 id="3-3-索引库及映射"><a href="#3-3-索引库及映射" class="headerlink" title="3.3.索引库及映射"></a>3.3.索引库及映射</h2><p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1596177823927.png" alt="1596177823927"></p>
<p>创建索引库的同时，我们也会创建type及其映射关系，但是这些操作不建议使用java客户端完成，原因如下：</p>
<ul>
<li><p>索引库和映射往往是初始化时完成，不需要频繁操作，不如提前配置好</p>
</li>
<li><p>官方提供的创建索引库及映射API非常繁琐，需要通过字符串拼接json结构：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1553654415047.png" alt="1553654415047"></p>
</li>
</ul>
<p>因此，这些操作建议还是使用我们昨天学习的Rest风格API去实现。</p>
<p>我们接下来以这样一个商品数据为例来创建索引库：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.es.pojo;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title; <span class="comment">//标题</span></span><br><span class="line">    <span class="keyword">private</span> String category;<span class="comment">// 分类</span></span><br><span class="line">    <span class="keyword">private</span> String brand; <span class="comment">// 品牌</span></span><br><span class="line">    <span class="keyword">private</span> Double price; <span class="comment">// 价格</span></span><br><span class="line">    <span class="keyword">private</span> String images; <span class="comment">// 图片地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析一下数据结构：</p>
<ul>
<li>id：可以认为是主键，将来判断数据是否重复的标示，不分词，可以使用keyword类型</li>
<li>title：搜索字段，需要分词，可以用text类型</li>
<li>category：商品分类，这个是整体，不分词，可以使用keyword类型</li>
<li>brand：品牌，与分类类似，不分词，可以使用keyword类型</li>
<li>price：价格，这个是double类型</li>
<li>images：图片，用来展示的字段，不搜索，index为false，不分词，可以使用keyword类型</li>
</ul>
<p>我们可以编写这样的映射配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PUT /leyou</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;item&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;id&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;title&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;category&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;brand&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;images&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;index&quot;</span>:  <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-4-索引数据操作"><a href="#3-4-索引数据操作" class="headerlink" title="3.4.索引数据操作"></a>3.4.索引数据操作</h2><p>有了索引库，我们接下来看看如何新增索引数据</p>
<h3 id="3-4-0-初始化客户端"><a href="#3-4-0-初始化客户端" class="headerlink" title="3.4.0.初始化客户端"></a>3.4.0.初始化客户端</h3><p>完成任何操作都需要通过HighLevelRestClient客户端，看下如何创建。</p>
<p>我们先编写一个测试类：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1553658784911.png" alt="1553658784911">  </p>
<p>然后再@Before的方法中编写client初始化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> syl</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticSearchTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient client;</span><br><span class="line">	<span class="comment">// Json工具</span></span><br><span class="line">    <span class="keyword">private</span> Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 初始化HighLevel客户端</span></span><br><span class="line">        client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">                RestClient.builder(</span><br><span class="line">                        HttpHost.create(<span class="string">&quot;http://127.0.0.1:9201&quot;</span>),</span><br><span class="line">                        HttpHost.create(<span class="string">&quot;http://127.0.0.1:9202&quot;</span>),</span><br><span class="line">                        HttpHost.create(<span class="string">&quot;http://127.0.0.1:9203&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 关闭客户端</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-4-1-新增文档"><a href="#3-4-1-新增文档" class="headerlink" title="3.4.1.新增文档"></a>3.4.1.新增文档</h3><p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 准备文档数据：</span></span><br><span class="line">    Item item = <span class="keyword">new</span> Item(<span class="number">1L</span>, <span class="string">&quot;小米手机9&quot;</span>, <span class="string">&quot; 手机&quot;</span>,</span><br><span class="line">                         <span class="string">&quot;小米&quot;</span>, <span class="number">3499.00</span>, <span class="string">&quot;http://image.leyou.com/13123.jpg&quot;</span>);</span><br><span class="line">    <span class="comment">// 转为Json格式：</span></span><br><span class="line">    String source = gson.toJson(item);</span><br><span class="line">    <span class="comment">// 创建一个新增索引的请求</span></span><br><span class="line">    IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;leyou&quot;</span>, <span class="string">&quot;item&quot;</span>, item.getId().toString())</span><br><span class="line">        <span class="comment">//添加数据，并指定是JSON格式</span></span><br><span class="line">        .source(source, XContentType.JSON);</span><br><span class="line">    <span class="comment">// 发起请求</span></span><br><span class="line">    IndexResponse response = client.index(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;response = &quot;</span> + response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看下响应：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">response = IndexResponse[</span><br><span class="line">    index=item,</span><br><span class="line">    type=docs,</span><br><span class="line">    id=1,</span><br><span class="line">    version=2,</span><br><span class="line">    result=created,</span><br><span class="line">    seqNo=1,</span><br><span class="line">    primaryTerm=1,</span><br><span class="line">    shards=&#123;&quot;total&quot;:2,&quot;successful&quot;:2,&quot;failed&quot;:0&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h3 id="3-4-2-查看文档"><a href="#3-4-2-查看文档" class="headerlink" title="3.4.2.查看文档"></a>3.4.2.查看文档</h3><p>根据rest风格，查看应该是根据id进行get查询，难点是对结果的解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建get请求，并指定id</span></span><br><span class="line">    GetRequest request = <span class="keyword">new</span> GetRequest(<span class="string">&quot;leyou&quot;</span>, <span class="string">&quot;item&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">// 是否进行结果source过滤</span></span><br><span class="line">    <span class="comment">// request.fetchSourceContext(new FetchSourceContext(true, null, null));</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询，得到响应</span></span><br><span class="line">    GetResponse response = client.get(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析响应，应该是json</span></span><br><span class="line">    String source = response.getSourceAsString();</span><br><span class="line">    <span class="comment">// 转换json数据</span></span><br><span class="line">    Item item = gson.fromJson(source, Item.class);</span><br><span class="line">    System.out.println(item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Item&#123;id=1, title=&#x27;小米手机9&#x27;, category=&#x27; 手机&#x27;, brand=&#x27;小米&#x27;, price=3499.0, images=&#x27;http://image.leyou.com/13123.jpg&#x27;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-4-3-修改文档"><a href="#3-4-3-修改文档" class="headerlink" title="3.4.3.修改文档"></a>3.4.3.修改文档</h3><p>新增时，如果传递的id是已经存在的，则会完成修改操作，如果不存在，则是新增。</p>
<h3 id="3-4-4-删除文档"><a href="#3-4-4-删除文档" class="headerlink" title="3.4.4.删除文档"></a>3.4.4.删除文档</h3><p>根据id删除：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 准备删除的请求，参数为id</span></span><br><span class="line">    DeleteRequest request = <span class="keyword">new</span> DeleteRequest(<span class="string">&quot;leyou&quot;</span>, <span class="string">&quot;item&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">// 发起请求</span></span><br><span class="line">    DeleteResponse response = client.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;response = &quot;</span> + response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-5-批量新增"><a href="#3-4-5-批量新增" class="headerlink" title="3.4.5.批量新增"></a>3.4.5.批量新增</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBulkIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 准备文档数据：</span></span><br><span class="line">    List&lt;Item&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">1L</span>, <span class="string">&quot;小米手机7&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;小米&quot;</span>, <span class="number">3299.00</span>, <span class="string">&quot;http://image.leyou.com/13123.jpg&quot;</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">2L</span>, <span class="string">&quot;坚果手机R1&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;锤子&quot;</span>, <span class="number">3699.00</span>, <span class="string">&quot;http://image.leyou.com/13123.jpg&quot;</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">3L</span>, <span class="string">&quot;华为META10&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;华为&quot;</span>, <span class="number">4499.00</span>, <span class="string">&quot;http://image.leyou.com/13123.jpg&quot;</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">4L</span>, <span class="string">&quot;小米Mix2S&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;小米&quot;</span>, <span class="number">4299.00</span>, <span class="string">&quot;http://image.leyou.com/13123.jpg&quot;</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Item(<span class="number">5L</span>, <span class="string">&quot;荣耀V10&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;华为&quot;</span>, <span class="number">2799.00</span>, <span class="string">&quot;http://image.leyou.com/13123.jpg&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建批量新增请求</span></span><br><span class="line">    BulkRequest request = <span class="keyword">new</span> BulkRequest();</span><br><span class="line">    <span class="keyword">for</span> (Item item : list) &#123;</span><br><span class="line">        <span class="comment">// 构建单个IndexRequest，并add到BulkRequest中去</span></span><br><span class="line">        request.add(<span class="keyword">new</span> IndexRequest(<span class="string">&quot;leyou&quot;</span>, <span class="string">&quot;item&quot;</span>, item.getId().toString())</span><br><span class="line">                    .source(gson.toJson(item), XContentType.JSON));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 发起请求</span></span><br><span class="line">    BulkResponse response = client.bulk(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(<span class="string">&quot;response = &quot;</span> + response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键点：</p>
<ul>
<li>BulkRequest：批量请求，可以添加多个IndexRequest对象，完成批处理</li>
</ul>
<h2 id="3-5-搜索数据"><a href="#3-5-搜索数据" class="headerlink" title="3.5.搜索数据"></a>3.5.搜索数据</h2><h3 id="3-5-1-查询所有match-all"><a href="#3-5-1-查询所有match-all" class="headerlink" title="3.5.1.查询所有match_all"></a>3.5.1.查询所有match_all</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMatchAll</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建搜索对象</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">    <span class="comment">// 查询构建工具</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 添加查询条件，通过QueryBuilders获取各种查询</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 搜索</span></span><br><span class="line">    SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析</span></span><br><span class="line">    SearchHits hits = response.getHits();</span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">        <span class="comment">// 取出source数据</span></span><br><span class="line">        String json = hit.getSourceAsString();</span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        Item item = gson.fromJson(json, Item.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;item = &quot;</span> + item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=5, title=&#x27;荣耀V10&#x27;, category=&#x27;手机&#x27;, brand=&#x27;华为&#x27;, price=2799.0, images=&#x27;http:<span class="comment">//image.leyou.com/13123.jpg&#x27;&#125;</span></span><br><span class="line">item = Item&#123;id=2, title=&#x27;坚果手机R1&#x27;, category=&#x27;手机&#x27;, brand=&#x27;锤子&#x27;, price=3699.0, images=&#x27;http:<span class="comment">//image.leyou.com/13123.jpg&#x27;&#125;</span></span><br><span class="line">item = Item&#123;id=4, title=&#x27;小米Mix2S&#x27;, category=&#x27;手机&#x27;, brand=&#x27;小米&#x27;, price=4299.0, images=&#x27;http:<span class="comment">//image.leyou.com/13123.jpg&#x27;&#125;</span></span><br><span class="line">item = Item&#123;id=1, title=&#x27;小米手机7&#x27;, category=&#x27;手机&#x27;, brand=&#x27;小米&#x27;, price=3299.0, images=&#x27;http:<span class="comment">//image.leyou.com/13123.jpg&#x27;&#125;</span></span><br><span class="line">item = Item&#123;id=3, title=&#x27;华为META10&#x27;, category=&#x27;手机&#x27;, brand=&#x27;华为&#x27;, price=4499.0, images=&#x27;http:<span class="comment">//image.leyou.com/13123.jpg&#x27;&#125;</span></span><br></pre></td></tr></table></figure>

<p>注意，上面的代码中，搜索条件是通过<code>sourceBuilder.query(QueryBuilders.matchAllQuery())</code>来添加的。这个<code>query()</code>方法接受的参数是：<code>QueryBuilder</code>接口类型。</p>
<p>这个接口提供了很多实现类，分别对应我们在之前中学习的不同类型的查询，例如：term查询、match查询、range查询、boolean查询等，如图：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1554348626154.png" alt="1554348626154"> </p>
<p>因此，我们如果要使用各种不同查询，其实仅仅是传递给<code>sourceBuilder.query()</code>方法的参数不同而已。而这些实现类不需要我们去<code>new</code>，官方提供了<code>QueryBuilders</code>工厂帮我们构建各种实现类：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1554348779338.png" alt="1554348779338"> </p>
<h3 id="3-5-2-关键字搜索match"><a href="#3-5-2-关键字搜索match" class="headerlink" title="3.5.2.关键字搜索match"></a>3.5.2.关键字搜索match</h3><p>其实搜索类型的变化，仅仅是利用QueryBuilders构建的查询对象不同而已，其他代码基本一致：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1553664109185.png" alt="1553664109185"></p>
<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=<span class="number">2</span>, title=<span class="string">&#x27;坚果手机R1&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;锤子&#x27;</span>, price=<span class="number">3699.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">1</span>, title=<span class="string">&#x27;小米手机7&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;小米&#x27;</span>, price=<span class="number">3299.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>



<p>因此，我们可以把这段代码封装，然后把查询条件作为参数传递：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">basicQuery</span><span class="params">(SearchSourceBuilder sourceBuilder)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建搜索对象</span></span><br><span class="line">        SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line"></span><br><span class="line">        request.source(sourceBuilder);</span><br><span class="line">        <span class="comment">// 搜索</span></span><br><span class="line">        SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析</span></span><br><span class="line">        SearchHits hits = response.getHits();</span><br><span class="line">        SearchHit[] searchHits = hits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">            <span class="comment">// 取出source数据</span></span><br><span class="line">            String json = hit.getSourceAsString();</span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            Item item = gson.fromJson(json, Item.class);</span><br><span class="line">            System.out.println(<span class="string">&quot;item = &quot;</span> + item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用封装的方法，并传递查询条件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMatchQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 查询构建工具</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 添加查询条件，通过QueryBuilders获取各种查询</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;手机&quot;</span>));</span><br><span class="line"></span><br><span class="line">    basicQuery(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-5-3-范围查询range"><a href="#3-5-3-范围查询range" class="headerlink" title="3.5.3.范围查询range"></a>3.5.3.范围查询range</h3><p>与页面上一样，支持下面的范围关键字：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>gt(Object from)</td>
<td>大于</td>
</tr>
<tr>
<td>gte(Object from)</td>
<td>大于等于</td>
</tr>
<tr>
<td>lt(Object from)</td>
<td>小于</td>
</tr>
<tr>
<td>lte(Object from)</td>
<td>小于等于</td>
</tr>
</tbody></table>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRangeQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 查询构建工具</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 添加查询条件，通过QueryBuilders获取各种查询</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gt(<span class="number">1000</span>).lt(<span class="number">4000</span>));</span><br><span class="line"></span><br><span class="line">    basicQuery(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=<span class="number">5</span>, title=<span class="string">&#x27;荣耀V10&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;华为&#x27;</span>, price=<span class="number">2799.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">2</span>, title=<span class="string">&#x27;坚果手机R1&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;锤子&#x27;</span>, price=<span class="number">3699.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">1</span>, title=<span class="string">&#x27;小米手机7&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;小米&#x27;</span>, price=<span class="number">3299.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>





<p>其他各种查询：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        searchSourceBuilder.query(QueryBuilders.matchAllQuery());  // 查询所有</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        searchSourceBuilder.query(QueryBuilders.termQuery(&quot;title&quot;,&quot;华为&quot;));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        searchSourceBuilder.query(QueryBuilders.matchQuery(&quot;title&quot;,&quot;华为手机&quot;));</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        searchSourceBuilder.query(QueryBuilders.rangeQuery(&quot;price&quot;).gte(4000).lte(5000));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        searchSourceBuilder.query(QueryBuilders.fuzzyQuery(&quot;title&quot;,&quot;大米&quot;).fuzziness(Fuzziness.ONE));</span></span><br><span class="line"></span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.boolQuery().must(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gte(<span class="number">4000</span>).lte(<span class="number">5000</span>)).must(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>,<span class="string">&quot;华为手机&quot;</span>)));</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>









<h3 id="3-5-4-source过滤"><a href="#3-5-4-source过滤" class="headerlink" title="3.5.4.source过滤"></a>3.5.4.source过滤</h3><p>默认情况下，索引库中所有数据都会返回，如果我们想只返回部分字段，可以通过source filter来控制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSourceFilter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建搜索对象</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">    <span class="comment">// 查询构建工具</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 添加查询条件，通过QueryBuilders获取各种查询</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加source过滤</span></span><br><span class="line">    sourceBuilder.fetchSource(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;id&quot;</span>, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;price&quot;</span>&#125;, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    basicQuery(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1554280774790.png" alt="1554280774790"></p>
<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=<span class="number">5</span>, title=<span class="string">&#x27;荣耀V10&#x27;</span>, category=<span class="string">&#x27;null&#x27;</span>, brand=<span class="string">&#x27;null&#x27;</span>, price=<span class="number">2799.0</span>, images=<span class="string">&#x27;null&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">2</span>, title=<span class="string">&#x27;坚果手机R1&#x27;</span>, category=<span class="string">&#x27;null&#x27;</span>, brand=<span class="string">&#x27;null&#x27;</span>, price=<span class="number">3699.0</span>, images=<span class="string">&#x27;null&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">4</span>, title=<span class="string">&#x27;小米Mix2S&#x27;</span>, category=<span class="string">&#x27;null&#x27;</span>, brand=<span class="string">&#x27;null&#x27;</span>, price=<span class="number">4299.0</span>, images=<span class="string">&#x27;null&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">1</span>, title=<span class="string">&#x27;小米手机7&#x27;</span>, category=<span class="string">&#x27;null&#x27;</span>, brand=<span class="string">&#x27;null&#x27;</span>, price=<span class="number">3299.0</span>, images=<span class="string">&#x27;null&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">3</span>, title=<span class="string">&#x27;华为META10&#x27;</span>, category=<span class="string">&#x27;null&#x27;</span>, brand=<span class="string">&#x27;null&#x27;</span>, price=<span class="number">4499.0</span>, images=<span class="string">&#x27;null&#x27;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>结果过滤：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">searchSourceBuilder.query(QueryBuilders.boolQuery().must(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>,<span class="string">&quot;华为手机&quot;</span>)).filter(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gte(<span class="number">4000</span>).lte(<span class="number">5000</span>)));</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="3-6-排序"><a href="#3-6-排序" class="headerlink" title="3.6.排序"></a>3.6.排序</h2><p>依然是通过sourceBuilder来配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSortQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建搜索对象</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">    <span class="comment">// 查询构建工具</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 添加查询条件，通过QueryBuilders获取各种查询</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加排序</span></span><br><span class="line">    sourceBuilder.sort(<span class="string">&quot;price&quot;</span>, SortOrder.ASC);</span><br><span class="line"></span><br><span class="line">    basicQuery(sourceBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=<span class="number">5</span>, title=<span class="string">&#x27;荣耀V10&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;华为&#x27;</span>, price=<span class="number">2799.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">1</span>, title=<span class="string">&#x27;小米手机7&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;小米&#x27;</span>, price=<span class="number">3299.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">2</span>, title=<span class="string">&#x27;坚果手机R1&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;锤子&#x27;</span>, price=<span class="number">3699.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">4</span>, title=<span class="string">&#x27;小米Mix2S&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;小米&#x27;</span>, price=<span class="number">4299.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">3</span>, title=<span class="string">&#x27;华为META10&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;华为&#x27;</span>, price=<span class="number">4499.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-7-分页"><a href="#3-7-分页" class="headerlink" title="3.7.分页"></a>3.7.分页</h2><p>分页需要视图层传递两个参数给我们：</p>
<ul>
<li>当前页：page</li>
<li>每页大小：size</li>
</ul>
<p>而elasticsearch中需要的不是当前页，而是起始位置，还好有公式可以计算出：</p>
<ul>
<li>起始位置：start = (page - 1) * size</li>
</ul>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSortAndPageQuery</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建搜索对象</span></span><br><span class="line">        SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">        <span class="comment">// 查询构建工具</span></span><br><span class="line">        SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">// 添加查询条件，通过QueryBuilders获取各种查询</span></span><br><span class="line">        sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加排序</span></span><br><span class="line">        sourceBuilder.sort(<span class="string">&quot;price&quot;</span>, SortOrder.ASC);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加分页</span></span><br><span class="line">        <span class="keyword">int</span> page = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> size = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">int</span> start = (page - <span class="number">1</span>) * size;</span><br><span class="line">        <span class="comment">// 配置分页</span></span><br><span class="line">        sourceBuilder.from(start);</span><br><span class="line">        sourceBuilder.size(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        basicQuery(sourceBuilder);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=<span class="number">5</span>, title=<span class="string">&#x27;荣耀V10&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;华为&#x27;</span>, price=<span class="number">2799.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">1</span>, title=<span class="string">&#x27;小米手机7&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;小米&#x27;</span>, price=<span class="number">3299.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">2</span>, title=<span class="string">&#x27;坚果手机R1&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;锤子&#x27;</span>, price=<span class="number">3699.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>当我们传page为2的时候，结果是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">item = Item&#123;id=<span class="number">4</span>, title=<span class="string">&#x27;小米Mix2S&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;小米&#x27;</span>, price=<span class="number">4299.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br><span class="line">item = Item&#123;id=<span class="number">3</span>, title=<span class="string">&#x27;华为META10&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;华为&#x27;</span>, price=<span class="number">4499.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-8-聚合"><a href="#3-8-聚合" class="headerlink" title="3.8.聚合"></a>3.8.聚合</h2><p>再来试试聚合，我们这里以brand字段来聚合，看看有哪些品牌，每个品牌有多少数量。</p>
<p>聚合关键是弄清楚这几点：</p>
<ul>
<li>聚合的字段是什么</li>
<li>聚合的类型是什么</li>
<li>给聚合起个名</li>
</ul>
<p>与查询类似，聚合条件通过<code>sourceBuilder.aggregation()</code>方法来设置，而参数是一个接口：<code>AggregationBuilder</code>，这个接口也有大量的实现类，代表不同的聚合种类：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1554349744329.png" alt="1554349744329"> </p>
<p>同样，我们也不需要自己去new，官方提供了一个工厂帮我们创建实例：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1554349849946.png" alt="1554349849946"> </p>
<p>代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAggregation</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建搜索对象</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">    <span class="comment">// 查询构建工具</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 添加查询条件，通过QueryBuilders获取各种查询</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchAllQuery());</span><br><span class="line">    <span class="comment">// 添加排序</span></span><br><span class="line">    sourceBuilder.sort(<span class="string">&quot;price&quot;</span>, SortOrder.ASC);</span><br><span class="line">    <span class="comment">// 配置size为0，因为不需要数据，只要聚合结果</span></span><br><span class="line">    sourceBuilder.size(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加聚合</span></span><br><span class="line">    sourceBuilder.aggregation(AggregationBuilders.terms(<span class="string">&quot;brandAgg&quot;</span>).field(<span class="string">&quot;brand&quot;</span>));</span><br><span class="line"></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取结果</span></span><br><span class="line">    SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 获取聚合结果</span></span><br><span class="line">    Aggregations aggregations = response.getAggregations();</span><br><span class="line">    <span class="comment">// 获取某个聚合</span></span><br><span class="line">    Terms terms = aggregations.get(<span class="string">&quot;brandAgg&quot;</span>);</span><br><span class="line">    <span class="comment">// 获取桶</span></span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : terms.getBuckets()) &#123;</span><br><span class="line">        <span class="comment">// 获取key，这里是品牌名称</span></span><br><span class="line">        System.out.println(<span class="string">&quot;品牌 : &quot;</span> + bucket.getKeyAsString());</span><br><span class="line">        <span class="comment">// 获取docCount，就是数量</span></span><br><span class="line">        System.out.println(<span class="string">&quot;count: &quot;</span> + bucket.getDocCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">品牌 : 华为</span><br><span class="line">count: <span class="number">2</span></span><br><span class="line">品牌 : 小米</span><br><span class="line">count: <span class="number">2</span></span><br><span class="line">品牌 : 锤子</span><br><span class="line">count: <span class="number">1</span></span><br></pre></td></tr></table></figure>



<h2 id="3-9-高亮"><a href="#3-9-高亮" class="headerlink" title="3.9.高亮"></a>3.9.高亮</h2><p>代码示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHighlight</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建搜索对象</span></span><br><span class="line">    SearchRequest request = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">    <span class="comment">// 查询构建工具</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 添加查询条件，通过QueryBuilders获取各种查询</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;小米手机&quot;</span>));</span><br><span class="line">    <span class="comment">// 高亮</span></span><br><span class="line">    HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder();</span><br><span class="line">    highlightBuilder.field(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">    highlightBuilder.preTags(<span class="string">&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;</span>);</span><br><span class="line">    highlightBuilder.postTags(<span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line">    sourceBuilder.highlighter(highlightBuilder);</span><br><span class="line"></span><br><span class="line">    request.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取结果</span></span><br><span class="line">    SearchResponse response = client.search(request, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">    SearchHits hits = response.getHits();</span><br><span class="line">    SearchHit[] hitList = hits.getHits();</span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : hitList) &#123;</span><br><span class="line">        <span class="comment">// 获取高亮结果</span></span><br><span class="line">        Map&lt;String, HighlightField&gt; fields = hit.getHighlightFields();</span><br><span class="line">        <span class="comment">// 取出标题</span></span><br><span class="line">        HighlightField titleField = fields.get(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">         </span><br><span class="line">        <span class="comment">// 获取其它字段</span></span><br><span class="line">        Item item = <span class="keyword">this</span>.gson.fromJson(hit.getSourceAsString(), Item.class);</span><br><span class="line">        <span class="comment">// 覆盖title</span></span><br><span class="line">        item.setTitle(title);</span><br><span class="line">        System.out.println(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<ul>
<li><p>查询条件中添加高亮字段：</p>
<ul>
<li><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1554356961547.png" alt="1554356961547"></li>
<li><code>new HighlightBuilder()</code>：创建高亮构建器</li>
<li><code>.field(&quot;title&quot;)</code>：指定高亮字段</li>
<li><code>.preTags(&quot;&quot;)</code>和<code>.postTags(&quot;&quot;)</code>：指定高亮的前置和后置标签</li>
</ul>
</li>
<li><p>解析高亮结果：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1554357142660.png" alt="1554357142660"></p>
</li>
</ul>
<h1 id="4-SpringDataElasticsearch"><a href="#4-SpringDataElasticsearch" class="headerlink" title="4.SpringDataElasticsearch"></a>4.SpringDataElasticsearch</h1><p>接下来我们学习Spring提供的elasticsearch组件：Spring Data Elasticsearch</p>
<h2 id="4-1-什么是SpringDataElasticsearch"><a href="#4-1-什么是SpringDataElasticsearch" class="headerlink" title="4.1.什么是SpringDataElasticsearch"></a>4.1.什么是SpringDataElasticsearch</h2><p>SpringDataElasticsearch（以后简称SDE）是Spring Data项目下的一个子模块。</p>
<p>查看 Spring Data的官网：<a target="_blank" rel="noopener" href="http://projects.spring.io/spring-data/">http://projects.spring.io/spring-data/</a></p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1526539628841.png" alt="1526539628841"> </p>
<p>Spring Data 的使命是给各种数据访问提供统一的编程接口，不管是关系型数据库（如MySQL），还是非关系数据库（如Redis），或者类似Elasticsearch这样的索引数据库。从而简化开发人员的代码，提高开发效率。</p>
<p>包含很多不同数据操作的模块：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1526539880872.png" alt="1526539880872"> </p>
<p>Spring Data Elasticsearch的页面：<a target="_blank" rel="noopener" href="https://projects.spring.io/spring-data-elasticsearch/">https://projects.spring.io/spring-data-elasticsearch/</a></p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1526540053252.png" alt="1526540053252"> </p>
<p>特征：</p>
<ul>
<li>支持Spring的基于<code>@Configuration</code>的java配置方式，或者XML配置方式</li>
<li>提供了用于操作ES的便捷工具类**<code>ElasticsearchTemplate</code>**。包括实现文档到POJO之间的自动智能映射。</li>
<li>利用Spring的数据转换服务实现的功能丰富的对象映射</li>
<li>基于注解的元数据映射方式，而且可扩展以支持更多不同的数据格式</li>
<li>根据持久层接口自动生成对应实现方法，无需人工编写基本操作代码（类似mybatis，根据接口自动得到实现）。当然，也支持人工定制查询</li>
</ul>
<h2 id="4-2-配置SpringDataElasticsearch"><a href="#4-2-配置SpringDataElasticsearch" class="headerlink" title="4.2.配置SpringDataElasticsearch"></a>4.2.配置SpringDataElasticsearch</h2><p>我们在pom文件中，引入SpringDataElasticsearch的启动器：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后，只需要在resources下新建application.yml文件，引入elasticsearch的host和port即可：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">elasticsearch:</span></span><br><span class="line">      <span class="attr">cluster-name:</span> <span class="string">leyou-elastic</span></span><br><span class="line">      <span class="attr">cluster-nodes:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9301,127.0.0.1:9302,127.0.0.1:9303</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是，SpringDataElasticsearch底层使用的不是Elasticsearch提供的RestHighLevelClient，而是TransportClient，并不采用Http协议通信，而是访问elasticsearch对外开放的tcp端口，我们之前集群配置中，设置的分别是：9301,9302,9303</p>
<p>添加引导类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EsApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EsApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>另外，SpringBoot已经帮我们配置好了各种SDE配置，并且注册了一个ElasticsearchTemplate供我们使用。接下来一起来试试吧。</p>
<h2 id="4-3-索引库操作"><a href="#4-3-索引库操作" class="headerlink" title="4.3.索引库操作"></a>4.3.索引库操作</h2><h3 id="4-3-1-创建索引库"><a href="#4-3-1-创建索引库" class="headerlink" title="4.3.1.创建索引库"></a>4.3.1.创建索引库</h3><p>准备一个pojo对象</p>
<p>然后准备一个新的实体类，作为下面与索引库对应的文档：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.es.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Goods</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title; <span class="comment">//标题</span></span><br><span class="line">    <span class="keyword">private</span> String category;<span class="comment">// 分类</span></span><br><span class="line">    <span class="keyword">private</span> String brand; <span class="comment">// 品牌</span></span><br><span class="line">    <span class="keyword">private</span> Double price; <span class="comment">// 价格</span></span><br><span class="line">    <span class="keyword">private</span> String images; <span class="comment">// 图片地址</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Goods</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Goods</span><span class="params">(Long id, String title, String category, String brand, Double price, String images)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.title = title;</span><br><span class="line">        <span class="keyword">this</span>.category = category;</span><br><span class="line">        <span class="keyword">this</span>.brand = brand;</span><br><span class="line">        <span class="keyword">this</span>.price = price;</span><br><span class="line">        <span class="keyword">this</span>.images = images;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们先创建一个测试类，然后注入ElasticsearchTemplate：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringElasticsearchTest</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchTemplate esTemplate;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>下面是创建索引库的API示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateIndex</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 创建索引库，并指定实体类的字节码</span></span><br><span class="line">    esTemplate.createIndex(Goods.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现没有，创建索引库需要指定的信息，比如：索引库名、类型名、分片、副本数量、还有映射信息都没有填写，这是怎么回事呢？</p>
<p>实际上，与我们自定义工具类类似，SDE也是通过实体类上的注解来配置索引库信息的，我们需要在Goods上添加下面的一些注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document(indexName = &quot;leyou&quot;, type = &quot;goods&quot;, shards = 3, replicas = 1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Goods</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String title; <span class="comment">//标题</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String category;<span class="comment">// 分类</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword)</span></span><br><span class="line">    <span class="keyword">private</span> String brand; <span class="comment">// 品牌</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Double)</span></span><br><span class="line">    <span class="keyword">private</span> Double price; <span class="comment">// 价格</span></span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword, index = false)</span></span><br><span class="line">    <span class="keyword">private</span> String images; <span class="comment">// 图片地址</span></span><br><span class="line">    <span class="comment">// 。。。略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>几个用到的注解：</p>
<ul>
<li>@Document：声明索引库配置<ul>
<li>indexName：索引库名称</li>
<li>type：类型名称，默认是“docs”</li>
<li>shards：分片数量，默认5</li>
<li>replicas：副本数量，默认1</li>
</ul>
</li>
<li>@Id：声明实体类的id</li>
<li>@Field：声明字段属性<ul>
<li>type：字段的数据类型</li>
<li>analyzer：指定分词器类型</li>
<li>index：是否创建索引</li>
</ul>
</li>
</ul>
<h3 id="4-3-2-创建映射"><a href="#4-3-2-创建映射" class="headerlink" title="4.3.2.创建映射"></a>4.3.2.创建映射</h3><p>刚才的注解已经把映射关系也配置上了，所以创建映射只需要这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMapping</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 创建索引库，并制定实体类的字节码</span></span><br><span class="line">    esTemplate.putMapping(Goods.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>查看索引库：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1584854172805.png" alt="1584854172805"></p>
<h2 id="4-4-索引数据CRUD"><a href="#4-4-索引数据CRUD" class="headerlink" title="4.4.索引数据CRUD"></a>4.4.索引数据CRUD</h2><p>SDE的索引数据CRUD并没有封装在ElasticsearchTemplate中，而是有一个叫做ElasticsearchRepository的接口：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1554378139181.png" alt="1554378139181"> </p>
<p>我们需要自定义接口，继承ElasticsearchRespository：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.es.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.es.pojo.Goods;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GoodsRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Goods</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-1-创建索引数据"><a href="#4-4-1-创建索引数据" class="headerlink" title="4.4.1.创建索引数据"></a>4.4.1.创建索引数据</h3><p>创建索引有单个创建和批量创建之分，先来看单个创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> GoodsRepository goodsRepository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDocument</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Goods goods = <span class="keyword">new</span> Goods(<span class="number">1L</span>, <span class="string">&quot;小米手机9&quot;</span>, <span class="string">&quot; 手机&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;小米&quot;</span>, <span class="number">3499.00</span>, <span class="string">&quot;http://image.leyou.com/13123.jpg&quot;</span>);</span><br><span class="line">    <span class="comment">// 添加索引数据</span></span><br><span class="line">    goodsRepository.save(goods);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来看批量创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDocuments</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 准备文档数据：</span></span><br><span class="line">    List&lt;Goods&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.add(<span class="keyword">new</span> Goods(<span class="number">1L</span>, <span class="string">&quot;小米手机7&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;小米&quot;</span>, <span class="number">3299.00</span>, <span class="string">&quot;/13123.jpg&quot;</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Goods(<span class="number">2L</span>, <span class="string">&quot;坚果手机R1&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;锤子&quot;</span>, <span class="number">3699.00</span>, <span class="string">&quot;/13123.jpg&quot;</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Goods(<span class="number">3L</span>, <span class="string">&quot;华为META10&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;华为&quot;</span>, <span class="number">4499.00</span>, <span class="string">&quot;/13123.jpg&quot;</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Goods(<span class="number">4L</span>, <span class="string">&quot;小米Mix2S&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;小米&quot;</span>, <span class="number">4299.00</span>, <span class="string">&quot;/13123.jpg&quot;</span>));</span><br><span class="line">    list.add(<span class="keyword">new</span> Goods(<span class="number">5L</span>, <span class="string">&quot;荣耀V10&quot;</span>, <span class="string">&quot;手机&quot;</span>, <span class="string">&quot;华为&quot;</span>, <span class="number">2799.00</span>, <span class="string">&quot;/13123.jpg&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加索引数据</span></span><br><span class="line">    goodsRepository.saveAll(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过elasticsearch-head查看：</p>
<p><img src="E:\java\javaee\4-Spring\day12-elasticsearch\讲义\assets\1554378494161.png" alt="1554378494161"></p>
<h3 id="4-4-2-查询索引数据"><a href="#4-4-2-查询索引数据" class="headerlink" title="4.4.2.查询索引数据"></a>4.4.2.查询索引数据</h3><p>默认提供了根据id查询，查询所有两个功能：</p>
<blockquote>
<p>根据id查询</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryById</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Optional&lt;Goods&gt; goodsOptional = goodsRepository.findById(<span class="number">3L</span>);</span><br><span class="line">    System.out.println(goodsOptional.orElse(<span class="keyword">null</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Item&#123;id=<span class="number">3</span>, title=<span class="string">&#x27;华为META10&#x27;</span>, category=<span class="string">&#x27;手机&#x27;</span>, brand=<span class="string">&#x27;华为&#x27;</span>, price=<span class="number">4499.0</span>, images=<span class="string">&#x27;http://image.leyou.com/13123.jpg&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>查询所有：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Iterable&lt;Goods&gt; list = goodsRepository.findAll();</span><br><span class="line">    list.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Item&#123;id=2, title=&#x27;坚果手机R1&#x27;, category=&#x27;手机&#x27;, brand=&#x27;锤子&#x27;, price=3699.0, images=&#x27;http://image.leyou.com/13123.jpg&#x27;&#125;</span><br><span class="line">Item&#123;id=4, title=&#x27;小米Mix2S&#x27;, category=&#x27;手机&#x27;, brand=&#x27;小米&#x27;, price=4299.0, images=&#x27;http://image.leyou.com/13123.jpg&#x27;&#125;</span><br><span class="line">Item&#123;id=5, title=&#x27;荣耀V10&#x27;, category=&#x27;手机&#x27;, brand=&#x27;华为&#x27;, price=2799.0, images=&#x27;http://image.leyou.com/13123.jpg&#x27;&#125;</span><br><span class="line">Item&#123;id=1, title=&#x27;小米手机7&#x27;, category=&#x27;手机&#x27;, brand=&#x27;小米&#x27;, price=3299.0, images=&#x27;http://image.leyou.com/13123.jpg&#x27;&#125;</span><br><span class="line">Item&#123;id=3, title=&#x27;华为META10&#x27;, category=&#x27;手机&#x27;, brand=&#x27;华为&#x27;, price=4499.0, images=&#x27;http://image.leyou.com/13123.jpg&#x27;&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-4-3-自定义方法查询"><a href="#4-4-3-自定义方法查询" class="headerlink" title="4.4.3.自定义方法查询"></a>4.4.3.自定义方法查询</h3><p>GoodsRepository提供的查询方法有限，但是它却提供了非常强大的自定义查询功能：</p>
<p>只要遵循SpringData提供的语法，我们可以任意定义方法声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GoodsRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Goods</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据价格区间查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> from 开始价格</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to 结束价格</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 符合条件的goods</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Goods&gt; <span class="title">findByPriceBetween</span><span class="params">(Double from, Double to)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无需写实现，SDE会自动帮我们实现该方法，我们只需要用即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQueryByPrice</span><span class="params">()</span></span>&#123;</span><br><span class="line">    List&lt;Goods&gt; list = goodsRepository.findByPriceBetween(<span class="number">1000d</span>, <span class="number">4000d</span>);</span><br><span class="line">    list.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Item&#123;id=2, title=&#x27;坚果手机R1&#x27;, category=&#x27;手机&#x27;, brand=&#x27;锤子&#x27;, price=3699.0, images=&#x27;http://image.leyou.com/13123.jpg&#x27;&#125;</span><br><span class="line">Item&#123;id=5, title=&#x27;荣耀V10&#x27;, category=&#x27;手机&#x27;, brand=&#x27;华为&#x27;, price=2799.0, images=&#x27;http://image.leyou.com/13123.jpg&#x27;&#125;</span><br><span class="line">Item&#123;id=1, title=&#x27;小米手机7&#x27;, category=&#x27;手机&#x27;, brand=&#x27;小米&#x27;, price=3299.0, images=&#x27;http://image.leyou.com/13123.jpg&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>支持的一些语法示例：</p>
<table>
<thead>
<tr>
<th>Keyword</th>
<th>Sample</th>
<th>Elasticsearch Query String</th>
</tr>
</thead>
<tbody><tr>
<td><code>And</code></td>
<td><code>findByNameAndPrice</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;price&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Or</code></td>
<td><code>findByNameOrPrice</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;should&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;price&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Is</code></td>
<td><code>findByName</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Not</code></td>
<td><code>findByNameNot</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must_not&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Between</code></td>
<td><code>findByPriceBetween</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>LessThanEqual</code></td>
<td><code>findByPriceLessThan</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>GreaterThanEqual</code></td>
<td><code>findByPriceGreaterThan</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : null,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Before</code></td>
<td><code>findByPriceBefore</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>After</code></td>
<td><code>findByPriceAfter</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : null,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Like</code></td>
<td><code>findByNameLike</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;?*&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>StartingWith</code></td>
<td><code>findByNameStartingWith</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;?*&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>EndingWith</code></td>
<td><code>findByNameEndingWith</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;*?&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Contains/Containing</code></td>
<td><code>findByNameContaining</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;**?**&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>In</code></td>
<td><code>findByNameIn(Collection&lt;String&gt;names)</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;bool&quot; : &#123;&quot;should&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>NotIn</code></td>
<td><code>findByNameNotIn(Collection&lt;String&gt;names)</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must_not&quot; : &#123;&quot;bool&quot; : &#123;&quot;should&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Near</code></td>
<td><code>findByStoreNear</code></td>
<td><code>Not Supported Yet !</code></td>
</tr>
<tr>
<td><code>True</code></td>
<td><code>findByAvailableTrue</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : true&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>False</code></td>
<td><code>findByAvailableFalse</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : false&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>OrderBy</code></td>
<td><code>findByAvailableTrueOrderByNameDesc</code></td>
<td><code>&#123;&quot;sort&quot; : [&#123; &quot;name&quot; : &#123;&quot;order&quot; : &quot;desc&quot;&#125; &#125;],&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : true&#125;&#125;&#125;&#125;</code></td>
</tr>
</tbody></table>
<h2 id="4-5-原生查询"><a href="#4-5-原生查询" class="headerlink" title="4.5.原生查询"></a>4.5.原生查询</h2><p>如果觉得上述接口依然不符合你的需求，SDE也支持原生查询，这个时候还是使用ElasticsearchTemplate</p>
<p>而查询条件的构建是通过一个名为<code>NativeSearchQueryBuilder</code>的类来完成的，不过这个类的底层还是使用的原生API中的<code>QueryBuilders</code>、<code>AggregationBuilders</code>、<code>HighlightBuilders</code>等工具。</p>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testNativeQuery</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 原生查询构建器</span></span><br><span class="line">    NativeSearchQueryBuilder queryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    <span class="comment">// 1.1 source过滤</span></span><br><span class="line">    queryBuilder.withSourceFilter(<span class="keyword">new</span> FetchSourceFilter(<span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">    <span class="comment">// 1.2搜索条件</span></span><br><span class="line">    queryBuilder.withQuery(QueryBuilders.matchQuery(<span class="string">&quot;title&quot;</span>, <span class="string">&quot;小米手机&quot;</span>));</span><br><span class="line">    <span class="comment">// 1.3分页及排序条件</span></span><br><span class="line">    queryBuilder.withPageable(</span><br><span class="line">        PageRequest.of(<span class="number">0</span>, <span class="number">2</span>,</span><br><span class="line">                       Sort.by(Sort.Direction.ASC, <span class="string">&quot;price&quot;</span>)));</span><br><span class="line">    <span class="comment">// 1.4高亮显示</span></span><br><span class="line">    <span class="comment">// queryBuilder.withHighlightBuilder(new HighlightBuilder().field(&quot;title&quot;));</span></span><br><span class="line">    <span class="comment">// 1.5聚合</span></span><br><span class="line">    queryBuilder.addAggregation(AggregationBuilders.terms(<span class="string">&quot;brandAgg&quot;</span>).field(<span class="string">&quot;brand&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建查询条件，并且查询</span></span><br><span class="line">    AggregatedPage&lt;Goods&gt; result = esTemplate.queryForPage(queryBuilder.build(), Goods.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、解析结果：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.1分页结果</span></span><br><span class="line">    <span class="keyword">long</span> total = result.getTotalElements();</span><br><span class="line">    <span class="keyword">int</span> totalPages = result.getTotalPages();</span><br><span class="line">    List&lt;Goods&gt; list = result.getContent();</span><br><span class="line">    System.out.println(<span class="string">&quot;总条数 = &quot;</span> + total);</span><br><span class="line">    System.out.println(<span class="string">&quot;总页数 = &quot;</span> + totalPages);</span><br><span class="line">    System.out.println(list);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.2.聚合结果</span></span><br><span class="line">    Aggregations aggregations = result.getAggregations();</span><br><span class="line">    Terms terms = aggregations.get(<span class="string">&quot;brandAgg&quot;</span>);</span><br><span class="line">    terms.getBuckets().forEach(b -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;品牌 = &quot;</span> + b.getKeyAsString());</span><br><span class="line">        System.out.println(<span class="string">&quot;count = &quot;</span> + b.getDocCount());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>上述查询不支持高亮结果，悲剧。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/elasticsearch/" rel="tag"># elasticsearch</a>
          
        </div>
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E9%9B%86%E7%BE%A4%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F"><span class="nav-number">1.</span> <span class="nav-text">1. 集群和分布式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E5%8D%95%E7%82%B9%E5%BC%8F%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 单点式服务的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E9%9B%86%E7%BE%A4"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1 高可用集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9B%86%E7%BE%A4"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2.2 负载均衡集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-%E7%A7%91%E5%AD%A6%E8%AE%A1%E7%AE%97%E9%9B%86%E7%BE%A4"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.2.3 科学计算集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E5%88%86%E5%B8%83%E5%BC%8Fweb%E5%BA%94%E7%94%A8"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 分布式web应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-1-%E5%8D%95%E4%BD%93%E5%BA%94%E7%94%A8"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.3.1 单体应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-2-%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="nav-number">1.3.2.</span> <span class="nav-text">1.3.2 分布式架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-3-%E9%AB%98%E5%8F%AF%E7%94%A8%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="nav-number">1.3.3.</span> <span class="nav-text">1.3.3 高可用分布式集群架构</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Elasticsearch%E9%9B%86%E7%BE%A4"><span class="nav-number">2.</span> <span class="nav-text">2.Elasticsearch集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E5%8D%95%E7%82%B9%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">2.1.</span> <span class="nav-text">2.1.单点的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E9%9B%86%E7%BE%A4%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">2.2.集群的结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1.数据分片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2.数据备份</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-number">2.3.</span> <span class="nav-text">2.3.搭建集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">2.4.</span> <span class="nav-text">2.4.测试集群中创建索引库</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Elasticsearch%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">3.</span> <span class="nav-text">3.Elasticsearch客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.1.</span> <span class="nav-text">3.1.客户端介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%88%9B%E5%BB%BADemo%E5%B7%A5%E7%A8%8B"><span class="nav-number">3.2.</span> <span class="nav-text">3.2.创建Demo工程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE"><span class="nav-number">3.2.1.</span> <span class="nav-text">3.2.1.初始化项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-pom%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.2.</span> <span class="nav-text">3.2.2.pom文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.3.</span> <span class="nav-text">3.2.3.配置文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E7%B4%A2%E5%BC%95%E5%BA%93%E5%8F%8A%E6%98%A0%E5%B0%84"><span class="nav-number">3.3.</span> <span class="nav-text">3.3.索引库及映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="nav-number">3.4.</span> <span class="nav-text">3.4.索引数据操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-0-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">3.4.1.</span> <span class="nav-text">3.4.0.初始化客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-1-%E6%96%B0%E5%A2%9E%E6%96%87%E6%A1%A3"><span class="nav-number">3.4.2.</span> <span class="nav-text">3.4.1.新增文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-2-%E6%9F%A5%E7%9C%8B%E6%96%87%E6%A1%A3"><span class="nav-number">3.4.3.</span> <span class="nav-text">3.4.2.查看文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-3-%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3"><span class="nav-number">3.4.4.</span> <span class="nav-text">3.4.3.修改文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-4-%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="nav-number">3.4.5.</span> <span class="nav-text">3.4.4.删除文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-5-%E6%89%B9%E9%87%8F%E6%96%B0%E5%A2%9E"><span class="nav-number">3.4.6.</span> <span class="nav-text">3.4.5.批量新增</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE"><span class="nav-number">3.5.</span> <span class="nav-text">3.5.搜索数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-1-%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89match-all"><span class="nav-number">3.5.1.</span> <span class="nav-text">3.5.1.查询所有match_all</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-2-%E5%85%B3%E9%94%AE%E5%AD%97%E6%90%9C%E7%B4%A2match"><span class="nav-number">3.5.2.</span> <span class="nav-text">3.5.2.关键字搜索match</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-3-%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2range"><span class="nav-number">3.5.3.</span> <span class="nav-text">3.5.3.范围查询range</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-4-source%E8%BF%87%E6%BB%A4"><span class="nav-number">3.5.4.</span> <span class="nav-text">3.5.4.source过滤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-%E6%8E%92%E5%BA%8F"><span class="nav-number">3.6.</span> <span class="nav-text">3.6.排序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-%E5%88%86%E9%A1%B5"><span class="nav-number">3.7.</span> <span class="nav-text">3.7.分页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-8-%E8%81%9A%E5%90%88"><span class="nav-number">3.8.</span> <span class="nav-text">3.8.聚合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-9-%E9%AB%98%E4%BA%AE"><span class="nav-number">3.9.</span> <span class="nav-text">3.9.高亮</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-SpringDataElasticsearch"><span class="nav-number">4.</span> <span class="nav-text">4.SpringDataElasticsearch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E4%BB%80%E4%B9%88%E6%98%AFSpringDataElasticsearch"><span class="nav-number">4.1.</span> <span class="nav-text">4.1.什么是SpringDataElasticsearch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E9%85%8D%E7%BD%AESpringDataElasticsearch"><span class="nav-number">4.2.</span> <span class="nav-text">4.2.配置SpringDataElasticsearch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E7%B4%A2%E5%BC%95%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="nav-number">4.3.</span> <span class="nav-text">4.3.索引库操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%BA%93"><span class="nav-number">4.3.1.</span> <span class="nav-text">4.3.1.创建索引库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84"><span class="nav-number">4.3.2.</span> <span class="nav-text">4.3.2.创建映射</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AECRUD"><span class="nav-number">4.4.</span> <span class="nav-text">4.4.索引数据CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE"><span class="nav-number">4.4.1.</span> <span class="nav-text">4.4.1.创建索引数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE"><span class="nav-number">4.4.2.</span> <span class="nav-text">4.4.2.查询索引数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.4.3.</span> <span class="nav-text">4.4.3.自定义方法查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-%E5%8E%9F%E7%94%9F%E6%9F%A5%E8%AF%A2"><span class="nav-number">4.5.</span> <span class="nav-text">4.5.原生查询</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">樊宇璇</span>

  
</div>








  <div class="footer-custom"><a target="_blank" href="https://www.webhek.com/misc-res/species-in-pieces/#">Something interesting</a></div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
